<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Cons√≥rcio - Clientes Finais</title>
    <link rel="stylesheet" href="/static/css/nexus-core.css">
    <link rel="stylesheet" href="/static/css/crm-cliente.css">
    <style>
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--nexus-space-xl);
            gap: var(--nexus-space-md);
        }

        .search-box {
            flex: 1;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            padding: var(--nexus-space-md);
            background: var(--nexus-card-bg);
            border: 1px solid var(--nexus-border-color);
            border-radius: var(--nexus-radius-md);
            color: var(--nexus-text-primary);
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--nexus-green);
        }

        .btn {
            padding: var(--nexus-space-md) var(--nexus-space-lg);
            border: none;
            border-radius: var(--nexus-radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--nexus-transition-all);
        }

        .btn-primary {
            background: var(--nexus-green);
            color: var(--nexus-bg-primary);
        }

        .btn-primary:hover {
            background: var(--nexus-green-hover);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.3);
        }

        .table-container {
            background: var(--nexus-card-bg);
            border: 1px solid var(--nexus-border-color);
            border-radius: var(--nexus-radius-lg);
            padding: var(--nexus-space-lg);
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            border-bottom: 2px solid var(--nexus-border-color);
        }

        .data-table th {
            color: var(--nexus-green);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            padding: var(--nexus-space-md);
            text-align: left;
        }

        .data-table td {
            color: var(--nexus-text-primary);
            padding: var(--nexus-space-md);
            border-bottom: 1px solid rgba(57, 255, 20, 0.1);
        }

        .data-table tbody tr:hover {
            background: rgba(57, 255, 20, 0.05);
        }

        .action-buttons {
            display: flex;
            gap: var(--nexus-space-sm);
        }

        .btn-icon {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--nexus-border-color);
            border-radius: var(--nexus-radius-sm);
            color: var(--nexus-text-secondary);
            cursor: pointer;
            font-size: 1rem;
            transition: var(--nexus-transition-all);
        }

        .btn-icon:hover {
            border-color: var(--nexus-green);
            color: var(--nexus-green);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--nexus-radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(57, 255, 20, 0.2);
            color: var(--nexus-green);
        }

        .badge-warning {
            background: rgba(255, 200, 0, 0.2);
            color: #ffc800;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: var(--nexus-space-xl);
        }

        .modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: var(--nexus-bg-secondary);
            border: 1px solid var(--nexus-border-color);
            border-radius: var(--nexus-radius-lg);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--nexus-space-xl);
            border-bottom: 1px solid var(--nexus-border-color);
        }

        .modal-title {
            color: var(--nexus-green);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .btn-close {
            background: transparent;
            border: none;
            color: var(--nexus-text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .btn-close:hover {
            color: var(--nexus-green);
        }

        .modal-body {
            padding: var(--nexus-space-xl);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--nexus-space-lg);
        }

        .form-group {
            margin-bottom: var(--nexus-space-lg);
        }

        .form-label {
            display: block;
            color: var(--nexus-green);
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: var(--nexus-space-sm);
        }

        .form-input {
            width: 100%;
            padding: var(--nexus-space-md);
            background: var(--nexus-card-bg);
            border: 1px solid var(--nexus-border-color);
            border-radius: var(--nexus-radius-md);
            color: var(--nexus-text-primary);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--nexus-green);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--nexus-space-md);
            padding: var(--nexus-space-xl);
            border-top: 1px solid var(--nexus-border-color);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--nexus-border-color);
            color: var(--nexus-text-primary);
        }

        .btn-secondary:hover {
            border-color: var(--nexus-green);
            color: var(--nexus-green);
        }

        @media (max-width: 768px) {
            .actions-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-logo">
            <img src="/static/images/nexus_Logotipo.png" alt="Nexus" style="height: 60px; margin-bottom: 1rem; filter: drop-shadow(0 0 20px rgba(57, 255, 20, 0.4));">
            <h2>Portal Cons√≥rcio</h2>
            <p>Gest√£o de Cons√≥rcios</p>
        </div>

        <ul class="sidebar-menu">
            <li class="menu-item">
                <a href="/portal-consorcio/dashboard" class="menu-link">
                    <span class="menu-icon">üìä</span>
                    <span class="menu-text">Dashboard</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="/portal-consorcio/clientes" class="menu-link active">
                    <span class="menu-icon">üë•</span>
                    <span class="menu-text">Clientes Finais</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="/portal-consorcio/boletos" class="menu-link">
                    <span class="menu-icon">üìÑ</span>
                    <span class="menu-text">Boletos</span>
                </a>
            </li>
        </ul>

        <button onclick="logout()" class="logout-btn">
            üö™ Sair
        </button>
    </div>

    <div class="main-content">
        <div class="topbar">
            <h1 class="page-title">Clientes Finais</h1>
        </div>

        <div class="content-wrapper">
            <div class="actions-bar">
                <div class="search-box">
                    <input
                        type="text"
                        id="searchInput"
                        class="search-input"
                        placeholder="üîç Buscar por nome, CPF ou contrato..."
                    >
                </div>
                <button onclick="abrirModalNovo()" class="btn btn-primary">
                    + Novo Cliente
                </button>
            </div>

            <div class="table-container">
                <div id="loading" class="loading">Carregando...</div>
                <table class="data-table" id="tabelaClientes" style="display: none;">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>CPF</th>
                            <th>Contrato</th>
                            <th>Grupo/Cota</th>
                            <th>Valor Cr√©dito</th>
                            <th>Parcela</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyClientes"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Novo/Editar Cliente -->
    <div id="modalCliente" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Novo Cliente</h2>
                <button class="btn-close" onclick="fecharModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="formCliente">
                    <input type="hidden" id="clienteId">

                    <h3 style="color: var(--nexus-green); margin-bottom: var(--nexus-space-lg);">Dados Pessoais</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" id="nomeCompleto" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">CPF *</label>
                            <input type="text" id="cpf" class="form-input" required maxlength="14">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data Nascimento</label>
                            <input type="date" id="dataNascimento" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="email" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telefone Celular *</label>
                            <input type="text" id="telefoneCelular" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">WhatsApp *</label>
                            <input type="text" id="whatsapp" class="form-input" required>
                        </div>
                    </div>

                    <h3 style="color: var(--nexus-green); margin: var(--nexus-space-xl) 0 var(--nexus-space-lg);">Dados do Cons√≥rcio</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">N√∫mero Contrato *</label>
                            <input type="text" id="numeroContrato" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Grupo *</label>
                            <input type="text" id="grupoConsorcio" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cota *</label>
                            <input type="text" id="cotaConsorcio" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valor Cr√©dito *</label>
                            <input type="number" step="0.01" id="valorCredito" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valor Parcela *</label>
                            <input type="number" step="0.01" id="valorParcela" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prazo (meses) *</label>
                            <input type="number" id="prazoMeses" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data Ades√£o *</label>
                            <input type="date" id="dataAdesao" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="statusContrato" class="form-input">
                                <option value="ativo">Ativo</option>
                                <option value="suspenso">Suspenso</option>
                                <option value="cancelado">Cancelado</option>
                                <option value="contemplado">Contemplado</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarCliente()">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        let clientes = [];

        async function carregarClientes() {
            try {
                const response = await fetch('/portal-consorcio/api/clientes');
                const data = await response.json();

                if (!response.ok || !data.success) {
                    if (response.status === 401) {
                        window.location.href = '/portal-consorcio/login';
                        return;
                    }
                    throw new Error(data.error);
                }

                clientes = data.clientes;
                renderizarClientes(clientes);

            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar clientes');
            }
        }

        function renderizarClientes(lista) {
            const tbody = document.getElementById('tbodyClientes');
            const loading = document.getElementById('loading');
            const tabela = document.getElementById('tabelaClientes');

            loading.style.display = 'none';
            tabela.style.display = 'table';

            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Nenhum cliente encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = lista.map(c => `
                <tr>
                    <td>${c.nome_completo}</td>
                    <td>${c.cpf}</td>
                    <td>${c.numero_contrato}</td>
                    <td>${c.grupo_consorcio} / ${c.cota_consorcio}</td>
                    <td>${formatarMoeda(c.valor_credito)}</td>
                    <td>${formatarMoeda(c.valor_parcela)}</td>
                    <td><span class="badge badge-${c.status_contrato === 'ativo' ? 'success' : 'warning'}">${c.status_contrato}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" onclick="editarCliente(${c.id})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-icon" onclick="deletarCliente(${c.id})" title="Deletar">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor || 0);
        }

        // Busca
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const termo = e.target.value.toLowerCase();
            const filtrados = clientes.filter(c =>
                c.nome_completo.toLowerCase().includes(termo) ||
                c.cpf.includes(termo) ||
                c.numero_contrato.toLowerCase().includes(termo)
            );
            renderizarClientes(filtrados);
        });

        function abrirModalNovo() {
            document.getElementById('modalTitle').textContent = 'Novo Cliente';
            document.getElementById('formCliente').reset();
            document.getElementById('clienteId').value = '';
            document.getElementById('modalCliente').classList.add('show');
        }

        function fecharModal() {
            document.getElementById('modalCliente').classList.remove('show');
        }

        async function salvarCliente() {
            const id = document.getElementById('clienteId').value;
            const dados = {
                nome_completo: document.getElementById('nomeCompleto').value,
                cpf: document.getElementById('cpf').value,
                data_nascimento: document.getElementById('dataNascimento').value || null,
                email: document.getElementById('email').value || null,
                telefone_celular: document.getElementById('telefoneCelular').value,
                whatsapp: document.getElementById('whatsapp').value,
                numero_contrato: document.getElementById('numeroContrato').value,
                grupo_consorcio: document.getElementById('grupoConsorcio').value,
                cota_consorcio: document.getElementById('cotaConsorcio').value,
                valor_credito: parseFloat(document.getElementById('valorCredito').value),
                valor_parcela: parseFloat(document.getElementById('valorParcela').value),
                prazo_meses: parseInt(document.getElementById('prazoMeses').value),
                data_adesao: document.getElementById('dataAdesao').value,
                status_contrato: document.getElementById('statusContrato').value
            };

            try {
                const url = id ? `/portal-consorcio/api/clientes/${id}` : '/portal-consorcio/api/clientes';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert(data.message);
                    fecharModal();
                    carregarClientes();
                } else {
                    alert(data.error || 'Erro ao salvar cliente');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar cliente');
            }
        }

        async function deletarCliente(id) {
            if (!confirm('Deseja realmente deletar este cliente?')) return;

            try {
                const response = await fetch(`/portal-consorcio/api/clientes/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert(data.message);
                    carregarClientes();
                } else {
                    alert(data.error || 'Erro ao deletar cliente');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao deletar cliente');
            }
        }

        async function logout() {
            if (!confirm('Deseja realmente sair?')) return;
            await fetch('/portal-consorcio/api/logout', { method: 'POST' });
            window.location.href = '/portal-consorcio/login';
        }

        // Carregar ao iniciar
        carregarClientes();
    </script>
</body>
</html>
