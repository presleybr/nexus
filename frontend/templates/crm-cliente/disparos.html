<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disparos - Nexus CRM</title>
    <!-- VERS√ÉO ATUALIZADA: 2025-11-28 00:25 - DEBUG N√öMEROS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Nexus Design System -->
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <link rel="stylesheet" href="/static/css/crm-cliente.css">

    <style>
        /* Estilos espec√≠ficos da p√°gina de Disparos */
        .card-automacao {
            margin-bottom: 2rem;
            border-left: 4px solid var(--cor-destaque, #39FF14);
            background: var(--cor-fundo-card, #1a1a1a);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-automacao:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(57, 255, 20, 0.1);
        }

        .card-automacao .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-automacao .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
        }

        .card-automacao .card-icon {
            font-size: 1.5rem;
        }

        /* Grid para cards grandes (3 colunas) */
        .cards-principais-grid {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 1.5rem !important;
            margin-bottom: 2rem !important;
        }

        .cards-principais-grid .card-automacao {
            margin-bottom: 0 !important;
            height: 100% !important;
        }

        @media (max-width: 1200px) {
            .cards-principais-grid {
                grid-template-columns: 1fr !important;
            }
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .config-item label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--cor-texto-primario, #fff);
            font-size: 0.95rem;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #diaDoMes {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--cor-borda, #333);
            border-radius: 8px;
            background: var(--cor-fundo-hover, #2a2a2a);
            color: var(--cor-texto-primario, #fff);
            font-size: 0.95rem;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        #diaDoMes:hover {
            border-color: var(--cor-destaque, #39FF14);
        }

        #diaDoMes:focus {
            outline: none;
            border-color: var(--cor-destaque, #39FF14);
        }

        .badge {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: #10b98120;
            color: #10b981;
            border: 1px solid #10b981;
        }

        .badge-error {
            background: #ef444420;
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .proximo-disparo {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--cor-fundo-hover, #2a2a2a);
            border-radius: 8px;
            border-left: 3px solid var(--cor-destaque, #39FF14);
        }

        .proximo-disparo strong {
            color: var(--cor-destaque, #39FF14);
        }

        .test-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--cor-borda, #333);
        }

        /* Ajustes para bot√µes na p√°gina */
        .btn, .btn-primary, .btn-secondary {
            width: 100%;
            margin-top: 1rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Bot√µes minimalistas para n√∫meros de notifica√ß√£o */
        .numero-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border: 1px solid #333;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .numero-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--cor-destaque, #39FF14);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(57, 255, 20, 0.15);
        }

        .numero-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(57, 255, 20, 0.1);
        }

        .numero-btn-editar:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .numero-btn-deletar:hover {
            border-color: #ef4444;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }
    </style>
</head>
<body>
    <div class="crm-container">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img src="/static/images/nexus_Logotipo.png" alt="Nexus" style="height: 80px; margin-bottom: 15px;">
            </div>
            <nav>
                <ul class="sidebar-menu">
                    <li class="menu-item">
                        <a href="/crm/dashboard" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            Dashboard
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/cadastro-clientes" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Clientes
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/whatsapp" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                            </svg>
                            WhatsApp
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/disparos" class="menu-link active">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                            Disparos
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/boletos" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <line x1="10" y1="9" x2="8" y2="9"></line>
                            </svg>
                            Boletos
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/automacao-canopus" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                                <line x1="12" y1="22.08" x2="12" y2="12"></line>
                            </svg>
                            Automa√ß√£o Canopus
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/monitoramento" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                            </svg>
                            Monitoramento
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/graficos" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <line x1="12" y1="20" x2="12" y2="10"></line>
                                <line x1="18" y1="20" x2="18" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="16"></line>
                            </svg>
                            Gr√°ficos
                        </a>
                    </li>
                </ul>
            </nav>
            <button class="logout-btn" onclick="logout()">
                <svg style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Sair
            </button>
        </aside>

        <main class="main-content">
            <header class="content-header"><h1>Disparos Autom√°ticos</h1><p class="breadcrumb">Envio de boletos via WhatsApp</p></header>

            <div class="cards-principais-grid">
                <!-- Se√ß√£o de Agendamento Mensal -->
                <div class="card card-automacao">
                <div class="card-header">
                    <span class="card-title">üìÖ Agendamento Mensal Autom√°tico</span>
                    <span class="card-icon">‚è∞</span>
                </div>
                <p style="color: var(--cor-texto-secundario, #888); margin: 0 0 1rem 0; line-height: 1.6; font-size: 0.9rem;">
                    Configure o disparo autom√°tico mensal entre <strong style="color: #39FF14;">08:00-18:00</strong> (MS)
                </p>

                <div class="test-section">
                    <button class="btn-primary" onclick="ativarDisparoAutomatico()" id="btnAtivarDisparo">
                        üöÄ Ativar Disparo Completo
                    </button>
                    <small style="display: block; margin-top: 0.75rem; color: var(--cor-texto-secundario, #888);">
                        <strong>Disparo Completo:</strong> Ativa o envio autom√°tico de boletos com mensagens personalizadas em sequ√™ncia
                    </small>

                    <button class="btn-primary" onclick="pausarDisparo()" id="btnPausarDisparo" style="margin-top: 1rem; background: #FFA500; display: none;">
                        ‚è∏Ô∏è Pausar Disparo
                    </button>
                    <small id="textoPausarDisparo" style="display: none; margin-top: 0.75rem; color: var(--cor-texto-secundario, #888);">
                        <strong>Pausar:</strong> Interrompe o disparo em andamento
                    </small>

                    <!-- STATUS EM TEMPO REAL -->
                    <div id="statusDisparoEmAndamento" style="display: none; margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(57, 255, 20, 0.1), rgba(0, 255, 255, 0.1)); border: 2px solid #39FF14; border-radius: 12px; animation: pulse 2s infinite;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div class="spinner" style="width: 24px; height: 24px; border: 3px solid #39FF14; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <h3 style="margin: 0; color: #39FF14; font-size: 1.2rem;">üöÄ DISPARO EM ANDAMENTO</h3>
                        </div>

                        <!-- Progresso -->
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; font-size: 1.1rem;" id="statusProgresso">0/0</span>
                                <span style="color: #39FF14; font-weight: 600;" id="statusPorcentagem">0%</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden; height: 20px;">
                                <div id="barraProgresso" style="background: linear-gradient(90deg, #39FF14, #00FFFF); width: 0%; height: 100%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>

                        <!-- Cliente Atual -->
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; border-left: 4px solid #39FF14;">
                            <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">üì§ ENVIANDO AGORA:</div>
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;" id="statusClienteNome">-</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
                                <div>
                                    <span style="color: #888;">üì± WhatsApp:</span>
                                    <span style="color: #39FF14; font-weight: 600; margin-left: 0.5rem;" id="statusWhatsApp">-</span>
                                </div>
                                <div>
                                    <span style="color: #888;">üÜî CPF:</span>
                                    <span style="color: #39FF14; font-weight: 600; margin-left: 0.5rem;" id="statusCPF">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Estat√≠sticas -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                            <div style="text-align: center; padding: 0.75rem; background: rgba(57, 255, 20, 0.1); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #39FF14;" id="statusEnviados">0</div>
                                <div style="font-size: 0.8rem; color: #888;">‚úÖ Enviados</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: rgba(255, 51, 51, 0.1); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #FF3333;" id="statusErros">0</div>
                                <div style="font-size: 0.8rem; color: #888;">‚ùå Erros</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: rgba(255, 165, 0, 0.1); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #FFA500;" id="statusPendentes">0</div>
                                <div style="font-size: 0.8rem; color: #888;">‚è≥ Pendentes</div>
                            </div>
                        </div>

                        <!-- Tempo decorrido -->
                        <div style="margin-top: 1rem; text-align: center; color: #888; font-size: 0.9rem;">
                            ‚è±Ô∏è Tempo decorrido: <span id="statusTempo" style="color: #39FF14; font-weight: 600;">00:00</span>
                        </div>
                    </div>

                    <style>
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                        @keyframes pulse {
                            0%, 100% { box-shadow: 0 0 20px rgba(57, 255, 20, 0.3); }
                            50% { box-shadow: 0 0 40px rgba(57, 255, 20, 0.6); }
                        }
                    </style>
                </div>
            </div>

                <!-- Se√ß√£o de N√∫meros de Notifica√ß√£o -->
                <div class="card card-automacao">
                <div class="card-header">
                    <span class="card-title">üì± N√∫meros que Recebem Notifica√ß√µes</span>
                    <span class="card-icon">üí¨</span>
                </div>
                <p style="color: var(--cor-texto-secundario, #888); margin: 0 0 1rem 0; line-height: 1.6; font-size: 0.9rem;">
                    Gerencie os n√∫meros que receber√£o notifica√ß√µes sobre disparos
                </p>

                <div id="listaNumeros" style="margin-top: 1.5rem;">
                    <div style="color: var(--cor-texto-secundario, #888);">Carregando n√∫meros...</div>
                </div>

                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--cor-borda, #333);">
                    <h4 style="color: var(--cor-destaque, #39FF14); margin-bottom: 1rem;">‚ûï Adicionar Novo N√∫mero</h4>
                    <div class="config-grid">
                        <div class="config-item">
                            <label>Nome/Descri√ß√£o</label>
                            <input type="text" id="novoNumeroNome" placeholder="Ex: Jo√£o - Gerente" style="width: 100%; padding: 0.75rem; border: 2px solid var(--cor-borda, #333); border-radius: 8px; background: var(--cor-fundo-hover, #2a2a2a); color: var(--cor-texto-primario, #fff); font-size: 0.95rem;">
                        </div>
                        <div class="config-item">
                            <label>N√∫mero WhatsApp</label>
                            <input type="text" id="novoNumeroWhatsapp" placeholder="Ex: 5567999999999" style="width: 100%; padding: 0.75rem; border: 2px solid var(--cor-borda, #333); border-radius: 8px; background: var(--cor-fundo-hover, #2a2a2a); color: var(--cor-texto-primario, #fff); font-size: 0.95rem;">
                            <small style="display: block; margin-top: 0.5rem; color: var(--cor-texto-secundario, #888);">
                                Formato: 55 + DDD + n√∫mero (sem espa√ßos)
                            </small>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="adicionarNumero()" style="margin-top: 1rem;">
                        ‚ûï Adicionar N√∫mero
                    </button>
                </div>
            </div>

            </div><!-- Fecha cards-principais-grid -->

            <div class="table-container">
                <h3 style="margin-bottom: 1rem; color: var(--cor-destaque);">üìä Hist√≥rico de Automa√ß√µes</h3>
                <div id="historico" class="loading">Carregando...</div>
            </div>
        </main>
    </div>

    <script>
        let configuracaoAutomacao = null;

        // Carrega configura√ß√µes ao iniciar
        async function carregarConfiguracoes() {
            try {
                const response = await fetch('/api/crm/configuracoes-automacao');
                const data = await response.json();

                if (data.success && data.configuracao) {
                    configuracaoAutomacao = data.configuracao;
                    atualizarInterfaceAutomacao();
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes:', error);
            }
        }

        function atualizarInterfaceAutomacao() {
            if (!configuracaoAutomacao) return;

            const habilitado = configuracaoAutomacao.disparo_automatico_habilitado;
            const diaDoMes = configuracaoAutomacao.dia_do_mes || 1;

            // Atualiza bot√£o de toggle
            const btn = document.getElementById('toggleAutomacao');
            const statusText = document.getElementById('statusText');
            const statusBadge = document.getElementById('statusBadge');

            if (habilitado) {
                btn.className = 'btn-primary';
                statusText.textContent = 'Desativar';
                statusBadge.textContent = 'Ativado';
                statusBadge.className = 'badge badge-success';
            } else {
                btn.className = 'btn-danger';
                statusText.textContent = 'Ativar';
                statusBadge.textContent = 'Desativado';
                statusBadge.className = 'badge badge-error';
            }

            // Preenche select de dias
            const select = document.getElementById('diaDoMes');
            if (select.options.length === 0) {
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Dia ${i}`;
                    select.appendChild(option);
                }
            }
            select.value = diaDoMes;

            // Calcula pr√≥ximo disparo
            if (habilitado) {
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                let proximaData;

                if (hoje.getDate() < diaDoMes) {
                    // Ainda n√£o passou o dia neste m√™s
                    proximaData = new Date(anoAtual, mesAtual, diaDoMes);
                } else {
                    // J√° passou, ser√° no pr√≥ximo m√™s
                    proximaData = new Date(anoAtual, mesAtual + 1, diaDoMes);
                }

                document.getElementById('dataProximoDisparo').textContent =
                    proximaData.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' }) +
                    ' entre 08:00 e 18:00';
                document.getElementById('proximoDisparo').style.display = 'block';
            } else {
                document.getElementById('proximoDisparo').style.display = 'none';
            }
        }

        async function toggleAutomacao() {
            if (!configuracaoAutomacao) return;

            const novoStatus = !configuracaoAutomacao.disparo_automatico_habilitado;

            const confirmacao = novoStatus
                ? 'Tem certeza que deseja ATIVAR os disparos autom√°ticos mensais?'
                : 'Tem certeza que deseja DESATIVAR os disparos autom√°ticos?';

            if (!confirm(confirmacao)) return;

            try {
                const response = await fetch('/api/crm/configuracoes-automacao', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        disparo_automatico_habilitado: novoStatus
                    })
                });

                const data = await response.json();

                if (data.success) {
                    configuracaoAutomacao.disparo_automatico_habilitado = novoStatus;
                    atualizarInterfaceAutomacao();
                    alert(novoStatus ? 'Automa√ß√£o ATIVADA com sucesso!' : 'Automa√ß√£o DESATIVADA com sucesso!');
                } else {
                    alert('Erro ao atualizar: ' + (data.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao atualizar configura√ß√£o');
            }
        }

        async function salvarDiaDoMes() {
            const diaDoMes = parseInt(document.getElementById('diaDoMes').value);

            try {
                const response = await fetch('/api/crm/configuracoes-automacao', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        dia_do_mes: diaDoMes
                    })
                });

                const data = await response.json();

                if (data.success) {
                    configuracaoAutomacao.dia_do_mes = diaDoMes;
                    atualizarInterfaceAutomacao();
                    alert('Dia do m√™s atualizado com sucesso!');
                } else {
                    alert('Erro ao atualizar: ' + (data.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao atualizar dia do m√™s');
            }
        }

        async function pausarDisparo() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nDeseja PAUSAR o disparo em andamento?\n\nIsso ir√°:\n‚è∏Ô∏è Pausar temporariamente o disparo\n‚úÖ Voc√™ poder√° continuar depois clicando em "Ativar Disparo"\n\nDeseja PAUSAR?')) return;

            const btn = document.getElementById('btnPausarDisparo');
            const btnAtivar = document.getElementById('btnAtivarDisparo');

            btn.disabled = true;
            btn.textContent = '‚è∏Ô∏è Pausando...';

            try {
                const response = await fetch('/api/crm/scheduler/pausar-disparo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                console.log('=== RESULTADO PAUSAR DISPARO ===');
                console.log('Dados completos:', data);

                if (data.success) {
                    alert('‚è∏Ô∏è Disparo pausado!\n\nClique em "Ativar Disparo Completo" para continuar de onde parou.');

                    // Atualizar texto do bot√£o pausar
                    btn.style.background = '#888';
                    btn.textContent = '‚è∏Ô∏è DISPARO PAUSADO';

                    // Atualizar bot√£o de ativar para mostrar que pode continuar
                    btnAtivar.textContent = '‚ñ∂Ô∏è Continuar Disparo';
                    btnAtivar.style.background = '#39FF14';

                    // Parar monitoramento
                    pararMonitoramento();
                    carregarHistorico();
                } else {
                    alert('‚ùå Erro: ' + (data.erro || data.message || 'Erro desconhecido'));
                    btn.textContent = '‚è∏Ô∏è Pausar Disparo';
                }
            } catch (error) {
                console.error('Erro ao pausar disparo:', error);
                alert('‚ùå Erro ao pausar disparo. Verifique o console.');
                btn.textContent = '‚è∏Ô∏è Pausar Disparo';
            } finally {
                btn.disabled = false;
            }
        }

        // Vari√°veis globais para monitoramento
        let intervalMonitoramento = null;
        let tempoInicioDisparo = null;
        let intervalTempo = null;

        async function ativarDisparoAutomatico() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nIsso ativar√° o disparo COMPLETO e autom√°tico de boletos!\n\nO sistema ir√°:\n‚úÖ Enviar mensagens personalizadas\n‚úÖ Enviar boletos em PDF\n‚úÖ Processar TODOS os clientes com boletos pendentes\n‚úÖ Seguir intervalo de seguran√ßa entre envios\n\nDeseja CONTINUAR?')) return;

            const btn = document.getElementById('btnAtivarDisparo');
            btn.disabled = true;
            btn.textContent = 'üöÄ Iniciando...';

            try {
                const response = await fetch('/api/crm/scheduler/ativar-disparo-completo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                console.log('=== RESULTADO DO DISPARO COMPLETO ===');
                console.log('Dados completos:', data);

                if (response.status === 409) {
                    // J√° existe disparo em andamento
                    alert('‚ö†Ô∏è ' + data.message);
                    // Iniciar monitoramento do disparo existente
                    iniciarMonitoramento();
                    return;
                }

                if (data.success) {
                    // Disparo iniciado com sucesso
                    alert('‚úÖ Disparo iniciado! Acompanhe o progresso abaixo.');
                    iniciarMonitoramento();
                } else {
                    alert('‚ùå Erro: ' + (data.erro || data.message || 'Erro desconhecido'));
                    btn.disabled = false;
                    btn.textContent = 'üöÄ Ativar Disparo Completo';
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao ativar disparo autom√°tico');
                btn.disabled = false;
                btn.textContent = 'üöÄ Ativar Disparo Completo';
            }
        }

        function iniciarMonitoramento() {
            // Mostrar painel de status
            document.getElementById('statusDisparoEmAndamento').style.display = 'block';

            // Mostrar bot√£o de pausar e esconder bot√£o de ativar
            document.getElementById('btnPausarDisparo').style.display = 'block';
            document.getElementById('textoPausarDisparo').style.display = 'block';
            document.getElementById('btnAtivarDisparo').style.display = 'none';

            // Iniciar contador de tempo
            tempoInicioDisparo = Date.now();
            if (intervalTempo) clearInterval(intervalTempo);
            intervalTempo = setInterval(atualizarTempo, 1000);

            // Iniciar polling do status (atualiza a cada 2 segundos)
            if (intervalMonitoramento) clearInterval(intervalMonitoramento);
            atualizarStatusDisparo(); // Primeira atualiza√ß√£o imediata
            intervalMonitoramento = setInterval(atualizarStatusDisparo, 2000);
        }

        function pararMonitoramento() {
            if (intervalMonitoramento) {
                clearInterval(intervalMonitoramento);
                intervalMonitoramento = null;
            }
            if (intervalTempo) {
                clearInterval(intervalTempo);
                intervalTempo = null;
            }

            // Esconder bot√£o de pausar e mostrar bot√£o de ativar
            document.getElementById('btnPausarDisparo').style.display = 'none';
            document.getElementById('textoPausarDisparo').style.display = 'none';
            document.getElementById('btnAtivarDisparo').style.display = 'block';

            // Esconder painel ap√≥s 3 segundos
            setTimeout(() => {
                document.getElementById('statusDisparoEmAndamento').style.display = 'none';

                // Reabilitar bot√£o
                const btn = document.getElementById('btnAtivarDisparo');
                btn.disabled = false;
                btn.textContent = 'üöÄ Ativar Disparo Completo';
            }, 3000);
        }

        function atualizarTempo() {
            if (!tempoInicioDisparo) return;

            const segundos = Math.floor((Date.now() - tempoInicioDisparo) / 1000);
            const minutos = Math.floor(segundos / 60);
            const segs = segundos % 60;

            document.getElementById('statusTempo').textContent =
                `${String(minutos).padStart(2, '0')}:${String(segs).padStart(2, '0')}`;
        }

        async function atualizarStatusDisparo() {
            try {
                const response = await fetch('/api/crm/scheduler/status-disparo-atual');
                const data = await response.json();

                if (!data.success || !data.disparo) {
                    // N√£o h√° disparo em andamento
                    pararMonitoramento();
                    carregarHistorico();
                    return;
                }

                const disparo = data.disparo;

                // Atualizar progresso
                const total = disparo.total || 0;
                const atual = disparo.atual || 0;
                const enviados = disparo.enviados || 0;
                const erros = disparo.erros || 0;
                const pendentes = total - atual;
                const porcentagem = total > 0 ? Math.round((atual / total) * 100) : 0;

                document.getElementById('statusProgresso').textContent = `${atual}/${total}`;
                document.getElementById('statusPorcentagem').textContent = `${porcentagem}%`;
                document.getElementById('barraProgresso').style.width = `${porcentagem}%`;

                // Atualizar cliente atual
                if (disparo.cliente_atual) {
                    document.getElementById('statusClienteNome').textContent = disparo.cliente_atual.nome || '-';
                    document.getElementById('statusWhatsApp').textContent = disparo.cliente_atual.whatsapp || '-';
                    document.getElementById('statusCPF').textContent = disparo.cliente_atual.cpf || '-';
                }

                // Atualizar estat√≠sticas
                document.getElementById('statusEnviados').textContent = enviados;
                document.getElementById('statusErros').textContent = erros;
                document.getElementById('statusPendentes').textContent = pendentes;

                // Verificar se conclu√≠do
                if (disparo.status === 'concluido' || disparo.status === 'cancelado' || disparo.status === 'erro') {
                    pararMonitoramento();

                    let mensagemFinal = '';
                    if (disparo.status === 'concluido') {
                        mensagemFinal = `‚úÖ DISPARO CONCLU√çDO!\n\nüìä Estat√≠sticas:\n‚Ä¢ Total: ${total}\n‚Ä¢ Enviados: ${enviados}\n‚Ä¢ Erros: ${erros}`;
                    } else if (disparo.status === 'cancelado') {
                        mensagemFinal = `‚è∏Ô∏è Disparo cancelado\n\nüìä Parcial:\n‚Ä¢ Processados: ${atual}/${total}\n‚Ä¢ Enviados: ${enviados}\n‚Ä¢ Erros: ${erros}`;
                    } else {
                        mensagemFinal = `‚ùå Disparo finalizado com erro\n\nüìä Parcial:\n‚Ä¢ Processados: ${atual}/${total}\n‚Ä¢ Enviados: ${enviados}\n‚Ä¢ Erros: ${erros}`;
                    }

                    alert(mensagemFinal);
                    carregarHistorico();
                }

            } catch (error) {
                console.error('Erro ao atualizar status:', error);
            }
        }

        async function executarAutomacaoCompleta() {
            if (!confirm('Isso ir√° gerar e enviar boletos para todos os clientes. Continuar?')) return;

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Processando...';

            try {
                const response = await fetch('/api/automation/executar-completa', {method: 'POST'});
                const data = await response.json();

                alert(`Automa√ß√£o conclu√≠da!\n\nClientes processados: ${data.clientes_processados}\nBoletos gerados: ${data.boletos_gerados}\nBoletos enviados: ${data.boletos_enviados}\nTempo total: ${data.tempo_total_segundos}s`);
                carregarHistorico();
            } catch (error) {
                alert('Erro ao executar automa√ß√£o');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Iniciar Automa√ß√£o';
            }
        }

        async function apenasGerarBoletos() {
            if (!confirm('Gerar boletos para todos os clientes?')) return;

            const response = await fetch('/api/automation/gerar-boletos', {method: 'POST'});
            const data = await response.json();

            alert(`${data.total_gerados} boletos gerados com sucesso!`);
            carregarHistorico();
        }

        async function enviarBoletoModelo() {
            // Solicitar mensagem personalizada (opcional)
            const mensagem = prompt('Digite uma mensagem personalizada (ou deixe em branco para usar a padr√£o):');

            if (mensagem === null) return; // Cancelou

            if (!confirm('Isso enviar√° o boleto modelo (modelo-boleto.pdf) para TODOS os clientes ativos via WhatsApp. Continuar?')) return;

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Enviando...';

            try {
                const response = await fetch('/api/crm/boletos-modelo/enviar-massa', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        mensagem: mensagem || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    let detalhes = `Boleto modelo enviado com sucesso!\n\n`;
                    detalhes += `Total de clientes: ${data.total_clientes}\n`;
                    detalhes += `Enviados com sucesso: ${data.total_enviados}\n`;
                    detalhes += `Erros: ${data.total_erros}\n\n`;

                    if (data.total_erros > 0) {
                        detalhes += `Clientes com erro:\n`;
                        data.resultados.filter(r => r.status === 'erro').forEach(r => {
                            detalhes += `- ${r.nome}: ${r.erro}\n`;
                        });
                    }

                    alert(detalhes);
                } else {
                    alert(`Erro ao enviar: ${data.erro || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar boleto modelo');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Enviar Modelo';
            }
        }

        async function carregarHistorico() {
            try {
                const response = await fetch('/api/automation/historico');
                const data = await response.json();

                if (!data.historico || data.historico.length === 0) {
                    document.getElementById('historico').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--cor-texto-secundario);">
                            <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">üì≠ Nenhuma automa√ß√£o executada ainda</p>
                            <small>Clique em "Ativar Disparo Completo" para iniciar o envio de boletos</small>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <table class="table-nexus">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Data/Hora</th>
                                <th>Tipo</th>
                                <th>Total</th>
                                <th>Enviados</th>
                                <th>Erros</th>
                                <th>Taxa</th>
                                <th>Detalhes</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.historico.forEach(h => {
                    const data_exec = new Date(h.data_execucao).toLocaleString('pt-BR');
                    const status = h.status || 'desconhecido';
                    const total = h.total_processados || 0;
                    const enviados = h.total_sucessos || 0;
                    const erros = h.total_erros || 0;
                    const taxa = total > 0 ? ((enviados / total) * 100).toFixed(1) : 0;

                    // √çcone e cor do status
                    let statusBadge = '';
                    let statusIcon = '';
                    let statusColor = '';

                    switch(status) {
                        case 'em_andamento':
                            statusIcon = 'üîÑ';
                            statusColor = '#FFA500';
                            statusBadge = 'Em Andamento';
                            break;
                        case 'concluido':
                            statusIcon = '‚úÖ';
                            statusColor = '#39FF14';
                            statusBadge = 'Conclu√≠do';
                            break;
                        case 'erro':
                            statusIcon = '‚ùå';
                            statusColor = '#FF3333';
                            statusBadge = 'Erro';
                            break;
                        case 'cancelado':
                            statusIcon = '‚è∏Ô∏è';
                            statusColor = '#888';
                            statusBadge = 'Cancelado';
                            break;
                        default:
                            statusIcon = '‚ùì';
                            statusColor = '#888';
                            statusBadge = status;
                    }

                    // Tipo de disparo formatado
                    let tipoFormatado = h.tipo_automacao || 'desconhecido';
                    if (tipoFormatado === 'manual_completo') tipoFormatado = 'üöÄ Disparo Manual';
                    if (tipoFormatado === 'agendado') tipoFormatado = '‚è∞ Agendado';
                    if (tipoFormatado === 'teste') tipoFormatado = 'üß™ Teste';

                    html += `
                        <tr style="border-left: 4px solid ${statusColor};">
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.2rem;">${statusIcon}</span>
                                    <span style="color: ${statusColor}; font-weight: 600;">${statusBadge}</span>
                                </div>
                            </td>
                            <td>
                                <div style="line-height: 1.4;">
                                    <div>${data_exec.split(' ')[0]}</div>
                                    <small style="color: #888;">${data_exec.split(' ')[1]}</small>
                                </div>
                            </td>
                            <td>${tipoFormatado}</td>
                            <td><strong>${total}</strong></td>
                            <td><span class="badge badge-success">${enviados}</span></td>
                            <td>${erros > 0 ? `<span class="badge badge-error">${erros}</span>` : '<span style="color: #888;">0</span>'}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="background: rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden; width: 60px; height: 8px;">
                                        <div style="background: ${taxa >= 80 ? '#39FF14' : taxa >= 50 ? '#FFA500' : '#FF3333'}; width: ${taxa}%; height: 100%;"></div>
                                    </div>
                                    <span style="font-size: 0.85rem; color: #888;">${taxa}%</span>
                                </div>
                            </td>
                            <td>
                                <button
                                    class="btn-secondary"
                                    style="font-size: 0.8rem; padding: 0.3rem 0.8rem;"
                                    onclick="mostrarDetalhesHistorico(${h.id}, '${statusBadge}', '${data_exec}', ${total}, ${enviados}, ${erros}, '${tipoFormatado}', ${h.tempo_execucao_segundos || 0})">
                                    üìä Ver Detalhes
                                </button>
                            </td>
                        </tr>
                    `;

                    // Mensagens de erro/alerta
                    if (status === 'erro' && h.detalhes) {
                        try {
                            const detalhes = typeof h.detalhes === 'string' ? JSON.parse(h.detalhes) : h.detalhes;
                            if (detalhes.erro) {
                                html += `
                                    <tr style="background: rgba(255, 51, 51, 0.1);">
                                        <td colspan="8" style="padding: 1rem 2rem;">
                                            <div style="color: #FF3333; font-size: 0.9rem;">
                                                <strong>‚ùå Erro:</strong> ${detalhes.erro}
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }
                        } catch (e) {}
                    }

                    // Se cancelado, mostrar info
                    if (status === 'cancelado') {
                        html += `
                            <tr style="background: rgba(136, 136, 136, 0.1);">
                                <td colspan="8" style="padding: 1rem 2rem;">
                                    <div style="color: #888; font-size: 0.9rem;">
                                        ‚è∏Ô∏è <strong>Disparo pausado/cancelado pelo usu√°rio</strong>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }

                    // Se em andamento, mostrar alerta
                    if (status === 'em_andamento') {
                        html += `
                            <tr style="background: rgba(255, 165, 0, 0.1); animation: pulse 2s infinite;">
                                <td colspan="8" style="padding: 1rem 2rem;">
                                    <div style="color: #FFA500; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <span class="spinner" style="width: 16px; height: 16px; border: 2px solid #FFA500; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span>
                                        <strong>Disparo em andamento...</strong> Aguarde a conclus√£o ou pause o disparo.
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                });

                html += `
                        </tbody>
                    </table>

                    <style>
                        @keyframes pulse {
                            0%, 100% { opacity: 1; }
                            50% { opacity: 0.7; }
                        }

                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                    </style>
                `;

                document.getElementById('historico').innerHTML = html;

            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
                document.getElementById('historico').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #FF3333;">
                        <p>‚ùå Erro ao carregar hist√≥rico</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        function mostrarDetalhesHistorico(id, status, data, total, enviados, erros, tipo, tempo) {
            const tempoMin = (tempo / 60).toFixed(1);
            const taxa = total > 0 ? ((enviados / total) * 100).toFixed(1) : 0;

            alert(`üìä DETALHES DO DISPARO #${id}\n\n` +
                  `Status: ${status}\n` +
                  `Data/Hora: ${data}\n` +
                  `Tipo: ${tipo}\n\n` +
                  `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n` +
                  `Total Processados: ${total}\n` +
                  `‚úÖ Enviados: ${enviados}\n` +
                  `‚ùå Erros: ${erros}\n` +
                  `üìà Taxa de Sucesso: ${taxa}%\n\n` +
                  `‚è±Ô∏è Tempo de Execu√ß√£o: ${tempoMin} minutos (${tempo}s)`);
        }

        // ===== GERENCIAMENTO DE N√öMEROS DE NOTIFICA√á√ÉO =====
        let numerosNotificacao = [];

        async function carregarNumeros() {
            try {
                console.log('=== CARREGANDO N√öMEROS DE NOTIFICA√á√ÉO ===');
                const response = await fetch('/api/crm/numeros-notificacao', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                const data = await response.json();
                console.log('Dados recebidos:', data);

                // Se n√£o autenticado, mostrar mensagem
                if (data.erro && data.erro.includes('autenticado')) {
                    document.getElementById('listaNumeros').innerHTML = '<p style="color: #fbbf24;">‚ö†Ô∏è Fa√ßa login novamente para carregar os n√∫meros</p>';
                    return;
                }

                if (data.success && data.numeros) {
                    numerosNotificacao = data.numeros;
                    console.log('‚úÖ N√∫meros carregados com sucesso:', numerosNotificacao.length, 'n√∫mero(s)');
                    renderizarListaNumeros();
                } else {
                    console.error('‚ùå Erro nos dados:', data);
                    document.getElementById('listaNumeros').innerHTML = '<p style="color: #ef4444;">Erro: ' + (data.erro || 'Erro desconhecido') + '</p>';
                }
            } catch (error) {
                console.error('‚ùå Exce√ß√£o ao carregar n√∫meros:', error);
                document.getElementById('listaNumeros').innerHTML = '<p style="color: #ef4444;">Erro ao carregar: ' + error.message + '</p>';
            }
        }

        function renderizarListaNumeros() {
            const container = document.getElementById('listaNumeros');

            if (numerosNotificacao.length === 0) {
                container.innerHTML = '<p style="color: var(--cor-texto-secundario, #888);">Nenhum n√∫mero cadastrado. Adicione um n√∫mero abaixo.</p>';
                return;
            }

            let html = '<div style="display: grid; gap: 1rem;">';

            numerosNotificacao.forEach(numero => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--cor-fundo-hover, #2a2a2a); border-radius: 8px; border-left: 3px solid var(--cor-destaque, #39FF14);">
                        <div>
                            <strong style="color: #fff; font-size: 1rem;">${numero.nome || 'Sem nome'}</strong><br>
                            <span style="color: var(--cor-texto-secundario, #888); font-size: 0.9rem;">üì± ${numero.whatsapp}</span>
                            ${numero.ativo ? '<span style="margin-left: 1rem; padding: 0.25rem 0.5rem; background: rgba(57, 255, 20, 0.1); color: #39FF14; border: 1px solid rgba(57, 255, 20, 0.3); border-radius: 4px; font-size: 0.8rem;">‚úì Ativo</span>' : '<span style="margin-left: 1rem; padding: 0.25rem 0.5rem; background: rgba(255, 255, 255, 0.05); color: #888; border: 1px solid #333; border-radius: 4px; font-size: 0.8rem;">‚úó Inativo</span>'}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editarNumero(${numero.id})" class="numero-btn numero-btn-editar">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="deletarNumero(${numero.id}, '${numero.nome}')" class="numero-btn numero-btn-deletar">
                                üóëÔ∏è Deletar
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        async function adicionarNumero() {
            const nome = document.getElementById('novoNumeroNome').value.trim();
            const whatsapp = document.getElementById('novoNumeroWhatsapp').value.trim();

            if (!nome) {
                alert('Por favor, informe um nome/descri√ß√£o para o n√∫mero!');
                return;
            }

            if (!whatsapp) {
                alert('Por favor, informe o n√∫mero de WhatsApp!');
                return;
            }

            // Valida√ß√£o b√°sica do formato
            if (whatsapp.length < 12 || whatsapp.length > 15) {
                alert('N√∫mero de WhatsApp inv√°lido! Use o formato: 5567999999999 (55 + DDD + n√∫mero)');
                return;
            }

            if (!whatsapp.startsWith('55')) {
                alert('N√∫mero deve come√ßar com 55 (c√≥digo do Brasil)');
                return;
            }

            try {
                const response = await fetch('/api/crm/numeros-notificacao', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        nome: nome,
                        whatsapp: whatsapp
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ N√∫mero adicionado com sucesso!');
                    document.getElementById('novoNumeroNome').value = '';
                    document.getElementById('novoNumeroWhatsapp').value = '';
                    carregarNumeros();
                } else {
                    alert('‚ùå Erro ao adicionar n√∫mero: ' + (data.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao adicionar n√∫mero');
            }
        }

        async function editarNumero(id) {
            const numero = numerosNotificacao.find(n => n.id === id);
            if (!numero) return;

            const novoNome = prompt('Nome/Descri√ß√£o:', numero.nome);
            if (novoNome === null) return;

            const novoWhatsapp = prompt('N√∫mero WhatsApp:', numero.whatsapp);
            if (novoWhatsapp === null) return;

            if (!novoNome.trim() || !novoWhatsapp.trim()) {
                alert('Nome e WhatsApp s√£o obrigat√≥rios!');
                return;
            }

            try {
                const response = await fetch(`/api/crm/numeros-notificacao/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        nome: novoNome.trim(),
                        whatsapp: novoWhatsapp.trim()
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ N√∫mero atualizado com sucesso!');
                    carregarNumeros();
                } else {
                    alert('‚ùå Erro ao atualizar: ' + (data.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao atualizar n√∫mero');
            }
        }

        async function deletarNumero(id, nome) {
            if (!confirm(`Tem certeza que deseja deletar o n√∫mero "${nome}"?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
                return;
            }

            try {
                const response = await fetch(`/api/crm/numeros-notificacao/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ N√∫mero deletado com sucesso!');
                    carregarNumeros();
                } else {
                    alert('‚ùå Erro ao deletar: ' + (data.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao deletar n√∫mero');
            }
        }

        // Limpar disparos travados ao carregar p√°gina
        async function limparDisparosTravados() {
            try {
                await fetch('/api/crm/scheduler/limpar-disparos-travados', {
                    method: 'POST'
                });
            } catch (error) {
                console.error('Erro ao limpar disparos travados:', error);
            }
        }

        // Inicializa√ß√£o
        limparDisparosTravados(); // Limpa disparos travados primeiro
        carregarConfiguracoes();
        carregarHistorico();
        carregarNumeros();

        function logout() {
            fetch('/api/auth/logout', {method: 'POST'}).then(() => window.location.href = '/');
        }
    </script>
</body>
</html>
