<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Nexus CRM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Nexus Design System -->
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <link rel="stylesheet" href="/static/css/crm-cliente.css">

    <style>
        .widget-automacao {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border-left: 4px solid #39FF14;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .widget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .widget-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .widget-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
            align-items: center;
        }

        .status-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.ativo {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        .status-indicator.inativo {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            display: flex;
            flex-direction: column;
        }

        .status-label {
            font-size: 0.85rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-value {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }

        .status-value.ativo {
            color: #10b981;
        }

        .status-value.inativo {
            color: #ef4444;
        }

        .dia-section {
            text-align: center;
            padding: 1rem;
            background: rgba(57, 255, 20, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(57, 255, 20, 0.2);
        }

        .dia-label {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .dia-value {
            font-size: 2rem;
            font-weight: 700;
            color: #39FF14;
        }

        .actions-section {
            display: flex;
            gap: 0.75rem;
        }

        .actions-section .btn-primary,
        .actions-section .btn-secondary {
            flex: 1;
        }

        .proximo-disparo-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(57, 255, 20, 0.05);
            border-radius: 6px;
            font-size: 0.9rem;
            color: #888;
            text-align: center;
        }

        .proximo-disparo-info strong {
            color: #39FF14;
        }

        @media (max-width: 1024px) {
            .widget-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .dia-section {
                text-align: left;
            }
        }

        /* Estilos da tabela de boletos (mesmo da p√°gina automa√ß√£o canopus) */
        .boletos-table {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .boletos-table h3 {
            color: #fff;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .table-container {
            overflow-x: auto;
        }

        .boletos-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .boletos-table thead {
            background: #222;
        }

        .boletos-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #39FF14;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .boletos-table tbody tr {
            border-bottom: 1px solid #333;
            transition: background 0.2s ease;
        }

        .boletos-table tbody tr:hover {
            background: #222;
        }

        .boletos-table td {
            padding: 1rem;
            color: #ccc;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-sucesso {
            background: rgba(57, 255, 20, 0.2);
            color: #39FF14;
        }

        .status-pendente {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-pago {
            background: rgba(57, 255, 20, 0.2);
            color: #39FF14;
        }

        .status-enviado {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .status-nao_enviado {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .action-btn {
            background: #333;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: #39FF14;
            color: #000;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="crm-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img src="/static/images/nexus_Logotipo.png" alt="Nexus" style="height: 80px; margin-bottom: 15px;">
                <p id="empresaNome">Carregando...</p>
            </div>

            <nav>
                <ul class="sidebar-menu">
                    <li class="menu-item">
                        <a href="/crm/dashboard" class="menu-link active">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            Dashboard
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/cadastro-clientes" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Clientes
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/whatsapp" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                            </svg>
                            WhatsApp
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/disparos" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                            Disparos
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/boletos" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <line x1="10" y1="9" x2="8" y2="9"></line>
                            </svg>
                            Boletos
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/automacao-canopus" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                                <line x1="12" y1="22.08" x2="12" y2="12"></line>
                            </svg>
                            Automa√ß√£o Canopus
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/monitoramento" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                            </svg>
                            Monitoramento
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/crm/graficos" class="menu-link">
                            <svg class="menu-icon" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                                <line x1="12" y1="20" x2="12" y2="10"></line>
                                <line x1="18" y1="20" x2="18" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="16"></line>
                            </svg>
                            Gr√°ficos
                        </a>
                    </li>
                </ul>
            </nav>

            <button class="logout-btn" onclick="logout()">
                <svg style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Sair
            </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <h1>Dashboard</h1>
                <p class="breadcrumb">Vis√£o geral do sistema</p>
            </header>

            <!-- Cards de Estat√≠sticas -->
            <div class="cards-grid">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Total de Clientes</span>
                        <span class="card-icon">üë•</span>
                    </div>
                    <div class="card-value" id="totalClientes">-</div>
                    <div class="card-footer">Clientes cadastrados</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Boletos Gerados</span>
                        <span class="card-icon">üìÑ</span>
                    </div>
                    <div class="card-value" id="totalBoletos">-</div>
                    <div class="card-footer">Total de boletos</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Boletos Enviados</span>
                        <span class="card-icon">‚úÖ</span>
                    </div>
                    <div class="card-value" id="boletosEnviados">-</div>
                    <div class="card-footer">Enviados com sucesso</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Boletos Pendentes</span>
                        <span class="card-icon">‚è≥</span>
                    </div>
                    <div class="card-value" id="boletosPendentes">-</div>
                    <div class="card-footer">Aguardando envio</div>
                </div>
            </div>

            <!-- Painel de Reset - APENAS STAGING -->
            <div id="painelResetStaging" style="display: none; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); border-left: 4px solid #ef4444; border-radius: 12px; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
                        <span style="font-size: 1.1rem; font-weight: 700; color: #ef4444;">MODO STAGING - Ferramentas de Desenvolvimento</span>
                    </div>
                    <p style="color: #888; margin-bottom: 1rem; font-size: 0.9rem;">
                        Estas op√ß√µes s√≥ aparecem no ambiente de staging e permitem resetar dados para testes.
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button onclick="resetarDadosBoletos()" style="
                            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                            color: white;
                            border: none;
                            padding: 0.75rem 1.5rem;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                            transition: transform 0.2s, box-shadow 0.2s;
                        " onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 15px rgba(239,68,68,0.4)';"
                           onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            üóëÔ∏è Resetar Clientes e Boletos
                        </button>
                        <button onclick="resetarApenasDownloads()" style="
                            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                            color: white;
                            border: none;
                            padding: 0.75rem 1.5rem;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                            transition: transform 0.2s, box-shadow 0.2s;
                        " onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 15px rgba(245,158,11,0.4)';"
                           onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            üì• Resetar Apenas Downloads
                        </button>
                    </div>
                </div>
            </div>

            <!-- A√ß√µes R√°pidas -->
            <div class="cards-grid">
                <div class="card" style="cursor: pointer;" onclick="window.location.href='/crm/cadastro-clientes'">
                    <div class="card-header">
                        <span class="card-title">Cadastrar Cliente</span>
                        <span class="card-icon">‚ûï</span>
                    </div>
                    <p style="color: var(--cor-texto-secundario);">Adicione novos clientes ao sistema</p>
                </div>

                <div class="card" style="cursor: pointer;" onclick="window.location.href='/crm/disparos'">
                    <div class="card-header">
                        <span class="card-title">Iniciar Disparo</span>
                        <span class="card-icon">üöÄ</span>
                    </div>
                    <p style="color: var(--cor-texto-secundario);">Envie boletos via WhatsApp</p>
                </div>

                <div class="card" style="cursor: pointer;" onclick="window.location.href='/crm/whatsapp'">
                    <div class="card-header">
                        <span class="card-title">Conectar WhatsApp</span>
                        <span class="card-icon">üì±</span>
                    </div>
                    <p style="color: var(--cor-texto-secundario);">Configure sua conex√£o WhatsApp</p>

                    <!-- Status da Automa√ß√£o -->
                    <div class="status-section" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div id="statusIndicator" class="status-indicator inativo"></div>
                        <div class="status-text">
                            <span class="status-label">Status Automa√ß√£o</span>
                            <span id="statusAutomacao" class="status-value inativo">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √öltimos Boletos -->
            <div class="boletos-table">
                <h3>üìã √öltimos Boletos</h3>
                <div id="ultimosBoletos" class="loading">Carregando...</div>
            </div>
        </main>
    </div>

    <script src="/static/js/crm-cliente.js"></script>

    <script>
        // Vari√°vel global para armazenar a configura√ß√£o
        let configuracaoAutomacao = null;

        // Carregar configura√ß√µes de automa√ß√£o
        async function carregarConfiguracaoAutomacao() {
            try {
                const response = await fetch('/api/crm/configuracoes-automacao');
                const data = await response.json();

                if (data.success && data.configuracao) {
                    configuracaoAutomacao = data.configuracao;
                    atualizarWidgetAutomacao();
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√£o de automa√ß√£o:', error);
            }
        }

        // Atualizar o widget com os dados carregados
        function atualizarWidgetAutomacao() {
            if (!configuracaoAutomacao) return;

            const habilitado = configuracaoAutomacao.disparo_automatico_habilitado;
            const diaDoMes = configuracaoAutomacao.dia_do_mes || 1;

            // Atualizar status (apenas elementos que existem)
            const statusText = document.getElementById('statusAutomacao');
            const statusIndicator = document.getElementById('statusIndicator');

            if (statusText && statusIndicator) {
                if (habilitado) {
                    statusText.textContent = 'Ativado';
                    statusText.className = 'status-value ativo';
                    statusIndicator.className = 'status-indicator ativo';
                } else {
                    statusText.textContent = 'Desativado';
                    statusText.className = 'status-value inativo';
                    statusIndicator.className = 'status-indicator inativo';
                }
            }
        }

        // Toggle automa√ß√£o (ativar/desativar)
        async function toggleAutomacaoDashboard() {
            if (!configuracaoAutomacao) return;

            const novoStatus = !configuracaoAutomacao.disparo_automatico_habilitado;

            const confirmacao = novoStatus
                ? 'Tem certeza que deseja ATIVAR os disparos autom√°ticos mensais?'
                : 'Tem certeza que deseja DESATIVAR os disparos autom√°ticos?';

            if (!confirm(confirmacao)) return;

            try {
                const response = await fetch('/api/crm/configuracoes-automacao', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        disparo_automatico_habilitado: novoStatus
                    })
                });

                const data = await response.json();

                if (data.success) {
                    configuracaoAutomacao.disparo_automatico_habilitado = novoStatus;
                    atualizarWidgetAutomacao();
                    alert(novoStatus ? 'Automa√ß√£o ATIVADA com sucesso!' : 'Automa√ß√£o DESATIVADA com sucesso!');
                } else {
                    alert('Erro ao atualizar: ' + (data.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao atualizar configura√ß√£o');
            }
        }

        // Carregar estat√≠sticas do dashboard
        async function carregarDashboardStats() {
            try {
                // 1. Buscar estat√≠sticas gerais do CRM
                const statsResponse = await fetch('/api/crm/dashboard-stats');
                const statsData = await statsResponse.json();

                if (statsData.success) {
                    // Atualizar cards de estat√≠sticas
                    document.getElementById('totalClientes').textContent = statsData.stats.total_clientes || 0;
                    document.getElementById('totalBoletos').textContent = statsData.stats.total_boletos || 0;
                    document.getElementById('boletosEnviados').textContent = statsData.stats.boletos_enviados || 0;
                    document.getElementById('boletosPendentes').textContent = statsData.stats.boletos_pendentes || 0;
                }

                // 2. Buscar boletos baixados (mesma API da automa√ß√£o-canopus)
                // Adicionar timestamp para evitar cache
                const timestamp = new Date().getTime();
                const boletosResponse = await fetch(`/api/automation/boletos-baixados?_=${timestamp}`, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                const boletosData = await boletosResponse.json();

                const container = document.getElementById('ultimosBoletos');

                if (boletosData.success && boletosData.data && boletosData.data.length > 0) {
                    // Pegar apenas os √∫ltimos 10 boletos
                    const ultimos10 = boletosData.data.slice(0, 10);
                    const totalBoletos = boletosData.data.length;

                    let html = '';

                    // Mostrar aviso se houver mais de 10 boletos
                    if (totalBoletos > 10) {
                        html += `
                            <div style="background: rgba(57, 255, 20, 0.1); border-left: 3px solid #39FF14; padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 4px;">
                                <span style="color: #39FF14; font-weight: 600;">üìä ${totalBoletos} boletos dispon√≠veis</span>
                                <span style="color: #888; margin-left: 1rem;">Exibindo os 10 mais recentes</span>
                            </div>
                        `;
                    }

                    html += `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente / CPF</th>
                                        <th>Valor</th>
                                        <th>Vencimento</th>
                                        <th>Arquivo</th>
                                        <th>Tamanho</th>
                                        <th>Status</th>
                                        <th>Disparo</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    ultimos10.forEach(boleto => {
                        // Mostrar CPF e valor extra√≠dos do PDF
                        const cpfDisplay = boleto.cpf && boleto.cpf !== 'N/A' ? boleto.cpf : '-';
                        const valorDisplay = boleto.dados_extraidos && boleto.valor > 0
                            ? `<strong style="color: #39FF14;">R$ ${boleto.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>`
                            : boleto.valor_str;
                        const statusClass = boleto.dados_extraidos ? 'sucesso' : 'pendente';
                        const statusEmoji = boleto.dados_extraidos ? '‚úÖ' : '‚ö†Ô∏è';
                        const statusTexto = boleto.dados_extraidos ? 'Processado' : 'Baixado';

                        // Status de disparo (WhatsApp)
                        let disparoClass = 'pendente';
                        let disparoEmoji = '‚è≥';
                        let disparoTexto = 'Pendente';

                        if (boleto.status_envio === 'enviado') {
                            disparoClass = 'enviado';
                            disparoEmoji = '‚úÖ';
                            disparoTexto = 'Enviado';
                        } else if (boleto.status_envio === 'erro') {
                            disparoClass = 'nao_enviado';
                            disparoEmoji = '‚ùå';
                            disparoTexto = 'Erro';
                        }

                        html += `
                            <tr>
                                <td>
                                    <strong>${boleto.cliente_nome}</strong>
                                    ${boleto.cpf && boleto.cpf !== 'N/A' ? `<br><small style="color: #888;">CPF: ${boleto.cpf}</small>` : ''}
                                </td>
                                <td>${valorDisplay}</td>
                                <td>${boleto.vencimento || boleto.mes}</td>
                                <td>${boleto.arquivo_nome}</td>
                                <td>${formatarTamanho(boleto.tamanho)}</td>
                                <td>
                                    <span class="status-badge status-${statusClass}">
                                        ${statusEmoji} ${statusTexto}
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge status-${disparoClass}">
                                        ${disparoEmoji} ${disparoTexto}
                                    </span>
                                </td>
                                <td>
                                    <button class="action-btn" onclick="baixarBoleto('${boleto.arquivo_nome}')">üì• Baixar</button>
                                </td>
                            </tr>
                        `;
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;

                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            <p>Nenhum boleto baixado ainda.</p>
                            <p style="margin-top: 1rem;">
                                <a href="/crm/automacao-canopus" style="color: #39FF14;">
                                    Clique aqui para baixar boletos ‚Üí
                                </a>
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas:', error);
                // Mostrar zeros em caso de erro
                document.getElementById('totalClientes').textContent = '0';
                document.getElementById('totalBoletos').textContent = '0';
                document.getElementById('boletosEnviados').textContent = '0';
                document.getElementById('boletosPendentes').textContent = '0';
            }
        }

        // Formatar tamanho de arquivo em bytes
        function formatarTamanho(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Baixar boleto PDF
        function baixarBoleto(nomeArquivo) {
            window.open(`/api/automation/download-boleto?nome=${encodeURIComponent(nomeArquivo)}`, '_blank');
        }

        /* REMOVIDO - Fun√ß√µes perigosas n√£o devem estar dispon√≠veis para o cliente final
        // Resetar e Reimportar Tudo
        async function resetarDados() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° DELETAR TODOS OS CLIENTES E BOLETOS existentes no banco de dados!\n\nüõë Esta a√ß√£o N√ÉO pode ser desfeita!\n\n‚ùå Os dados ser√£o PERMANENTEMENTE APAGADOS!\n\nDeseja continuar?')) {
                return;
            }

            // Perguntar se deseja deletar arquivos f√≠sicos tamb√©m
            const deletarArquivos = confirm('üìÅ Deseja tamb√©m DELETAR OS ARQUIVOS F√çSICOS (PDFs) dos boletos?\n\n‚úÖ SIM = Deleta banco + arquivos (limpeza completa)\n‚ùå N√ÉO = Deleta apenas o banco (arquivos permanecem)\n\nRecomendado: SIM para limpeza completa');

            if (!confirm(`Confirma√ß√£o Final:\n\nüóëÔ∏è Voc√™ est√° prestes a APAGAR:\n- Banco de dados (clientes e boletos)\n${deletarArquivos ? '- Arquivos f√≠sicos (PDFs)\n' : ''}\nTem certeza ABSOLUTA?`)) {
                return;
            }

            // Mostrar loading
            const container = document.getElementById('ultimosBoletos');
            container.innerHTML = '<div class="loading">‚è≥ Resetando dados...</div>';

            try {
                const response = await fetch('/api/automation/resetar-dados', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        deletar_arquivos: deletarArquivos
                    })
                });

                const result = await response.json();

                if (result.success) {
                    let mensagem = `‚úÖ Dados resetados com sucesso!\n\n` +
                                  `Registros Deletados do Banco:\n` +
                                  `- ${result.clientes_deletados} clientes\n` +
                                  `- ${result.boletos_deletados} boletos\n`;

                    if (deletarArquivos && result.arquivos_deletados > 0) {
                        mensagem += `\nArquivos F√≠sicos Deletados:\n` +
                                   `- ${result.arquivos_deletados} PDFs\n`;
                    }

                    mensagem += `\nO sistema est√° limpo e pronto para nova importa√ß√£o.`;

                    alert(mensagem);

                    // For√ßar reload completo sem cache
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 500);
                } else {
                    alert('‚ùå Erro ao resetar dados: ' + result.error);
                    container.innerHTML = `<div class="empty-state"><p>Erro ao resetar dados. Tente novamente.</p></div>`;
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao conectar com o servidor');
                container.innerHTML = `<div class="empty-state"><p>Erro de conex√£o. Tente novamente.</p></div>`;
            }
        }

        async function resetarReimportar() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° DELETAR TODOS OS CLIENTES E BOLETOS existentes no banco de dados!\n\nDepois, reimportar√° tudo do zero a partir do Excel e dos PDFs baixados.\n\nüõë Esta a√ß√£o N√ÉO pode ser desfeita!\n\nDeseja continuar?')) {
                return;
            }

            if (!confirm('Tem certeza MESMO? Todos os dados atuais ser√£o perdidos!')) {
                return;
            }

            // Mostrar loading
            const container = document.getElementById('ultimosBoletos');
            container.innerHTML = '<div class="loading">‚è≥ Resetando e reimportando dados...</div>';

            try {
                const response = await fetch('/api/automation/resetar-e-reimportar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ Reimporta√ß√£o completa!\n\n` +
                          `Dados Deletados:\n` +
                          `- ${result.dados_antigos.clientes_deletados} clientes\n` +
                          `- ${result.dados_antigos.boletos_deletados} boletos\n\n` +
                          `Dados Importados:\n` +
                          `- ${result.dados_novos.clientes_importados} clientes\n` +
                          `- ${result.dados_novos.boletos_importados} boletos\n\n` +
                          `Atualizando dashboard...`);

                    // Recarregar dashboard
                    carregarDashboardStats();
                } else {
                    alert('‚ùå Erro ao resetar e reimportar: ' + result.error);
                    container.innerHTML = `<div class="empty-state"><p>Erro ao resetar dados. Tente novamente.</p></div>`;
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao conectar com o servidor');
                container.innerHTML = `<div class="empty-state"><p>Erro de conex√£o. Tente novamente.</p></div>`;
            }
        }
        */

        // Verificar se est√° em ambiente staging
        function isStaging() {
            const hostname = window.location.hostname;
            return hostname.includes('staging') ||
                   hostname.includes('localhost') ||
                   hostname.includes('127.0.0.1') ||
                   hostname.includes('develop');
        }

        // Mostrar painel de reset apenas em staging
        function verificarAmbienteStaging() {
            if (isStaging()) {
                const painel = document.getElementById('painelResetStaging');
                if (painel) {
                    painel.style.display = 'block';
                }
            }
        }

        // Resetar clientes, boletos e downloads
        async function resetarDadosBoletos() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nIsso vai apagar TODOS os dados de:\n- Clientes Finais\n- Boletos\n- Downloads Canopus\n\nTem certeza?')) {
                return;
            }

            if (!confirm('üî¥ √öLTIMA CONFIRMA√á√ÉO!\n\nEsta a√ß√£o N√ÉO pode ser desfeita.\n\nDigite "RESET" mentalmente e clique OK para confirmar.')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/reset-dados-boletos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Dados resetados com sucesso!\n\n' +
                          `Clientes removidos: ${data.clientes_removidos}\n` +
                          `Boletos removidos: ${data.boletos_removidos}\n` +
                          `Downloads removidos: ${data.downloads_removidos}`);

                    // Recarregar estat√≠sticas
                    carregarDashboardStats();
                } else {
                    alert('‚ùå Erro ao resetar dados:\n' + data.error);
                }
            } catch (error) {
                alert('‚ùå Erro ao conectar com o servidor:\n' + error.message);
            }
        }

        // Resetar apenas downloads
        async function resetarApenasDownloads() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nIsso vai apagar TODOS os downloads da tabela downloads_canopus.\n\nTem certeza?')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/reset-downloads', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Downloads resetados com sucesso!\n\n' +
                          `Downloads removidos: ${data.downloads_removidos}`);
                } else {
                    alert('‚ùå Erro ao resetar downloads:\n' + data.error);
                }
            } catch (error) {
                alert('‚ùå Erro ao conectar com o servidor:\n' + error.message);
            }
        }

        // Inicializar ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            carregarConfiguracaoAutomacao();
            carregarDashboardStats();
            verificarAmbienteStaging();

            // Recarregar estat√≠sticas a cada 30 segundos
            setInterval(carregarDashboardStats, 30000);
        });
    </script>
</body>
</html>
